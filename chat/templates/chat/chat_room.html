{% extends "base.html" %}

{% load static %}

{% block title %}Duesseldorf|Event{% endblock title %}

{% block head %}
{% endblock head%}


{% block content %}
<!DOCTYPE html>
<body>


<link rel="stylesheet" type="text/css" href="{% static 'chat/style.css' %}">

<div class="container">

<div class="header2">
{{ room.name }}
</div>

<div class="chat-room-body">
{% for message in messages %}
    <div class="chat-box">
        <div class="chat-header">
            <img src= {{message.user.profile.profile_picture.url}} class="user-icon">   {{message.user.username}}
        </div>
        <div class="chat-body">
            <p>{{message.content}}</p>
        </div>
    </div>
{% endfor %}
    <div id="footer"></div>
</div>

<div class="chat-room-footer">
    <div class="send-msg">
        <input placeholder="名前を入力" id="name" value="{{request.user}}" disabled/>
        <input placeholder="メッセージを入力" id="msg" value=""/><button id="send">送信</button>
    </div>
</div>

</div>

<script>

const ws = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/chat/'
            + '{{room.name}}'
            + '/'
        );

document.getElementById("send").onclick = function sendMessage () {
    var sendData = {
        name: document.getElementById('name').value,
        message: document.getElementById('msg').value
    }
    ws.send(JSON.stringify(sendData))
    console.log(JSON.stringify(sendData))
}

ws.onmessage = e => {
    var receiveData = JSON.parse(e.data)
    var messageBox = document.createElement('div')
    messageBox.className = 'chat-box'
    var header = '<div class="chat-header">' + receiveData.name + '</div>'
    var body = '<div class="chat-body">' + receiveData.message + '</div>'
    document.getElementById('footer').insertAdjacentHTML('beforebegin', header + body)
    document.getElementById('footer').appendChild(messageBox)
    window.location.reload(true);
}


</script>

</body>
{% endblock content %}
